# 上程機能 仕様書

## 概要

上程機能は、報告書などの承認フローを管理する機能です。上程者が報告書を提出し、複数の承認者による承認を経て完了するまでのプロセスを管理します。

## データベース設計

### Approvals テーブル

```sql
CREATE TABLE [dbo].[Approvals] (
  [Id] int identity not null,
  [ReportNo] nvarchar(50) not null,  -- 報告書No
  [Year] int not null,                 -- 年
  [Month] int not null,               -- 月
  [UserName] nvarchar(100) not null,  -- 対象のユーザー名
  [FlowOrder] int not null,            -- フロー順序番号（0: 上程者, 1: 承認者1, 2: 承認者2, ...）
  [Status] int not null,               -- 状態番号
  [Comment] nvarchar(1000) null,        -- コメント
  [ActionDate] datetime null,          -- 上程or承認をした日付
  [Created_At] datetime default getdate() not null,
  [Updated_At] datetime default getdate() not null,
  primary key (Id)
);
```

### Status（状態番号）の定義

- **0**: 上程済み（上程者が上程ボタンを押した状態）
- **1**: 承認待ち（前の承認者が承認済みで、次の承認者の承認待ち）
- **2**: 承認済み
- **3**: 差し戻し
- **4**: 取り戻し（上程者が取り戻した状態）
- **5**: 完了（すべての承認が完了した状態）
- **6**: 承認スキップ（後続の承認者が承認または差し戻ししたため、スキップされた状態）

### FlowOrder（フロー順序）について

- **0**: 上程者
- **1**: 承認者 1
- **2**: 承認者 2
- **3**: 承認者 3
- ... の順序

## 上程フローの基本仕様

### 1. 新規上程

1. 上程者がコメントを入力し、承認者を順番に選択
2. 「上程」ボタンをクリック
3. 上程者のレコードが作成される（FlowOrder=0, Status=0）
4. 選択した承認者のレコードが作成される（FlowOrder=1,2,3..., Status=1）
5. 最初の承認者が承認待ちの状態になる

### 2. 承認処理

1. 承認待ち（Status=1）または承認スキップ（Status=6）の承認者が承認を実行
2. 承認者の Status が 2（承認済み）に変更される
3. 次の承認者がいる場合、その承認者の Status が 1（承認待ち）になる
4. 最後の承認者が承認した場合、Status が 5（完了）になる

### 3. 差し戻し処理

1. 承認待ち（Status=1）または承認スキップ（Status=6）の承認者が差し戻しを実行
2. 差し戻しした承認者の Status が 3（差し戻し）に変更される
3. **差し戻しした承認者より前の承認待ち（Status=1）の承認者は、Status=6（承認スキップ）に変更される**
4. **差し戻しした承認者より後の承認待ち（Status=1）の承認者は削除される**
5. これにより、フローの最後が差し戻しのレコードになり、再上程が可能になる

### 4. 承認スキップ

- 後続の承認者が承認または差し戻しした場合、前の承認待ちの承認者が承認スキップ（Status=6）になる
- 承認スキップされた承認者は、後から承認を実行して承認済み（Status=2）に変更できる

### 5. 再上程処理

1. 差し戻しが発生した後、再上程フォームが自動表示される
2. ログインユーザーが新しい上程者として、コメントを入力し、承認者を選択
3. 「再上程」ボタンをクリック
4. 最新の差し戻しの FlowOrder の次の FlowOrder に、新しい上程者のレコードが作成される（Status=0）
5. 選択した承認者のレコードが作成される（Status=1）
6. 既存の再上程がある場合は、削除してから新しい再上程を作成

### 6. フロー表示の色付けロジック

**基本方針：基本はすべて灰色で表示し、現在のフェーズでアクティブな部分のみ色付け**

#### 完了状態の場合

- 完了のカードのみ緑色で表示
- それ以外（差し戻しを含む）はすべて灰色

#### 完了状態以外の場合

1. **最新の差し戻し**

   - 最新の差し戻し（最大 FlowOrder の Status=3）のみ赤色で表示
   - それ以外の差し戻しは灰色

2. **再上程フェーズの場合**

   - 再上程の上程者：青色
   - 再上程の承認者（自分の番・承認待ち/承認スキップ）：黄色
   - それ以外（一回目の上程など）：灰色

3. **通常フェーズの場合**
   - 自分の番（承認待ち/承認スキップ）：黄色
   - 自分の番（承認済み）：緑色
   - 自分の番（上程済み）で承認待ちがある場合：青色
   - 上程者（自分の番でない）で承認待ちがある場合：青色
   - それ以外：灰色

## 主要な機能

### 承認者のスキップ機能

承認者を 2 人選択している場合、2 人目の承認者が先に承認または差し戻しした場合：

- 1 人目の承認待ちの承認者は、Status=6（承認スキップ）に変更される
- 承認スキップされた承認者は、後から承認を実行できる

### 再上程の制約

- 差し戻しが発生していない場合は再上程できない
- 最新の差し戻し以降に既に再上程がある場合、その再上程を削除してから新しい再上程を作成
- 再上程の上程者は、ログインユーザーが自動的に設定される（選択不可）

## コンポーネント構成

### ApprovalDrawer.tsx

- 上程フォームと承認フローの表示を管理
- 上程、承認、差し戻し、再上程の処理を実行

### ApprovalFlowCard.tsx

- 承認フローの各カードを表示する汎用コンポーネント
- 色付けロジックを内包

### useApproval.ts

- 上程機能の状態管理を行うカスタムフック
- 承認状態の取得、上程、承認、差し戻し、再上程の処理を提供

## API エンドポイント

### POST /api/approval

新規上程を作成

### GET /api/approval

上程状態を取得（year, month, reportNo でフィルタリング可能）

### POST /api/approval/action

承認または差し戻しを実行

### POST /api/approval/resubmit

再上程を実行

## 注意事項

- 上程者はログインユーザー固定（選択不可）
- 承認者は順番に選択（複数選択不可）
- 差し戻しが発生した場合、その後の承認待ちの承認者は削除される
- 承認スキップされた承認者は、後から承認を実行できる
- 完了状態の場合、完了のカードのみ色付けされ、それ以外はすべて灰色
